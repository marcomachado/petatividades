<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Relatório PET Saúde – URCA</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="wrap">
    <!-- Cabeçalho com a imagem -->
    <div class="headerCard">
      <img class="headerImg" src="./cabecalho-pet-saude.png" alt="Cabeçalho PET Saúde">
    </div>

    <!-- Títulos -->
    <div class="titleBlock">
      <div class="titleLine">PROGRAMA PET SAÚDE INFORMAÇÃO E SAÚDE DIGITAL</div>
      <div class="titleLine">URCA/ SMS CRATO/ SMS JUAZEIRO DO NORTE/ ADS CRATO/ SMS IGUATU</div>
    </div>

    <main class="card" style="margin-top:12px">
      <!-- Cabeçalho -->
      <section class="content-narrow" style="padding:16px 0 0">
        <div class="grid cols-2">
          <div>
            <label>Bolsista/ Voluntário *</label>
            <input id="colaborador" required />
          </div>
          <div>
            <label>Vínculo *</label>
            <input id="vinculo" required />
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div>
            <label>Eixo Temático *</label>
            <select id="eixo" required>
              <option value="" selected disabled>Selecione...</option>
              <option value="I">I</option>
              <option value="II">II</option>
              <option value="III">III</option>
              <option value="IV">IV</option>
            </select>
          </div>
          <div>
            <label>Atividade do GT *</label>
            <select id="atividadeGT" required>
              <option value="" selected disabled>Selecione...</option>
              <option value="GT1">GT 1: Trabalho</option>
              <option value="GT2">GT 2: Formação</option>
              <option value="GT3">GT 3: Pesquisa</option>
            </select>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div>
            <label>Período (mês/ano) *</label>
            <input id="periodo" type="month" required />
          </div>
          <div></div>
        </div>

        <!-- Cenário sozinho na última linha -->
        <div class="grid" style="margin-top:12px">
          <div>
            <label>Cenário *</label>
            <input id="cenario" required />
          </div>
        </div>
      </section>

      <!-- Tabela centralizada e mais estreita -->
      <div class="content-narrow">
        <div class="tableWrap">
          <table id="tabela">
            <thead>
              <tr>
                <th class="col-sel">Sel.</th>
                <th class="col-date">Data</th>
                <th>Atividade / Observações</th>
                <th class="col-time">Entrada</th>
                <th class="col-time">Saída</th>
                <th class="col-carga">Carga Horária</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
              <tr>
                <td class="col-sel"></td>
                <td class="col-date"></td>
                <td class="num" colspan="3">Total do período</td>
                <td class="num col-carga" id="tfootTotal">00:00</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Botões em linha única -->
        <div class="toolbar toolbar-inline">
          <div class="left-buttons">
            <button class="btn primary" id="addLinha">+ Adicionar linha</button>
            <button class="btn" id="dupLinha">Duplicar</button>
            <button class="btn danger" id="remSel">Remover</button>
            <button class="btn" id="limparTudo">Limpar</button>
          </div>
          <div class="middle-buttons">
            <button class="btn" id="btnImprimir">Imprimir</button>
            <button class="btn success" id="btnBaixarPDF">Baixar PDF (paisagem)</button>
          </div>
          <div class="right-buttons">
            <button class="btn" id="exportJson">Exportar JSON</button>
            <button class="btn" id="importJson">Importar JSON</button>
          </div>
        </div>

        <!-- Assinaturas -->
        <div class="sig-area">
          <div class="sig-box">Assinatura do Bolsista</div>
          <div class="sig-box">Assinatura do Tutor/ Coordenador do Grupo Tutorial</div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== Helpers =====
    function toMinutes(hhmm){
      if(!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
      const [h,m]=hhmm.split(':').map(Number);
      if(h>23||m>59) return null;
      return h*60+m;
    }
    function fromMinutes(min){
      if(min==null) return "00:00";
      const s = Math.max(0, Math.floor(min));
      const h = Math.floor(s/60);
      const m = s % 60;
      return (h+"").padStart(2,"0")+":"+(""+m).padStart(2,"0");
    }
    function computeCarga(entrada, saida){
      const ei = toMinutes(entrada);
      const so = toMinutes(saida);
      if(ei==null || so==null) return {min:null, ok:false};
      const dur = so - ei;
      return {min: dur, ok: dur>0};
    }

    // ===== Estado / DOM =====
    const tbody = document.getElementById('tbody');
    const tfootTotal = document.getElementById('tfootTotal');

    const HDR_KEYS = ['colaborador','vinculo','periodo','cenario'];
    const SELECT_KEYS = ['eixo','atividadeGT'];

    let linhas = [];

    function linhaDOM(l){
      const tr = document.createElement('tr');

      // Sel.
      const tdSel = document.createElement('td'); tdSel.style.textAlign='center';
      const chk = document.createElement('input'); chk.type='checkbox';
      tdSel.appendChild(chk);

      // Data (picker) — no pt-BR, o navegador exibe dd/MM/yyyy
      const tdData = document.createElement('td');
      const inpData = document.createElement('input');
      inpData.type = 'date';
      inpData.value = l.data || '';
      inpData.addEventListener('change', ()=>{l.data=inpData.value; save();});
      tdData.appendChild(inpData);

      // Descrição
      const tdDesc = document.createElement('td');
      const txt = document.createElement('textarea');
      txt.rows = 2; txt.placeholder = "Descreva a atividade, local, OS, etc.";
      txt.value = l.desc || '';
      txt.addEventListener('input', ()=>{l.desc=txt.value; save();});
      tdDesc.appendChild(txt);

      // Entrada
      const tdEnt = document.createElement('td');
      const ent = document.createElement('input');
      ent.type='time'; ent.step=60; ent.value = l.entrada || '';
      ent.addEventListener('input', ()=>{l.entrada=ent.value; recalcLinha(l,tr); save();});
      tdEnt.appendChild(ent);

      // Saída
      const tdSai = document.createElement('td');
      const sai = document.createElement('input');
      sai.type='time'; sai.step=60; sai.value = l.saida || '';
      sai.addEventListener('input', ()=>{l.saida=sai.value; recalcLinha(l,tr); save();});
      tdSai.appendChild(sai);

      // Carga Horária
      const tdCarga = document.createElement('td'); tdCarga.className='num';
      tdCarga.textContent = l.carga || '00:00';

      tr.append(tdSel, tdData, tdDesc, tdEnt, tdSai, tdCarga);
      recalcLinha(l,tr);
      return tr;
    }

    function recalcLinha(l,tr){
      const cargaCell = tr.children[5];
      const {min, ok} = computeCarga(l.entrada, l.saida);
      if(min==null){ cargaCell.textContent='00:00'; l.carga='00:00'; tr.classList.remove('invalid'); recalcTotal(); return; }
      if(!ok){ tr.classList.add('invalid'); l.carga='00:00'; cargaCell.textContent='00:00'; recalcTotal(); return; }
      const hhmm = fromMinutes(min);
      l.carga = hhmm;
      tr.classList.remove('invalid');
      cargaCell.textContent = hhmm;
      recalcTotal();
    }

    function recalcTotal(){
      const totalMin = linhas.reduce((a,l)=>{
        const parts = /^\d{2}:\d{2}$/.test(l.carga||'') ? l.carga.split(':').map(Number) : [0,0];
        return a + parts[0]*60 + parts[1];
      },0);
      tfootTotal.textContent = fromMinutes(totalMin);
    }

    function render(){
      tbody.innerHTML='';
      linhas.forEach(l => tbody.appendChild(linhaDOM(l)));
      recalcTotal();
    }

    // ===== Persistência =====
    function getHeader(){
      const header = Object.fromEntries(HDR_KEYS.map(id=>{
        const el = document.getElementById(id);
        return [id, el?.value || ""];
      }));
      SELECT_KEYS.forEach(id=>{
        const el = document.getElementById(id);
        header[id] = el?.value || "";
      });
      return header;
    }
    function setHeader(header){
      if(!header) return;
      HDR_KEYS.forEach(id=>{
        const el = document.getElementById(id);
        if(el && header[id]!=null) el.value = header[id];
      });
      SELECT_KEYS.forEach(id=>{
        const el = document.getElementById(id);
        if(el && header[id]!=null) el.value = header[id];
      });
    }
    function save(){
      const data = {header:getHeader(), linhas};
      localStorage.setItem('petSaudeRelatorio:v5', JSON.stringify(data));
    }
    function load(){
      const raw = localStorage.getItem('petSaudeRelatorio:v5')
        || localStorage.getItem('petSaudeRelatorio:v4')
        || localStorage.getItem('petSaudeRelatorio:v3')
        || localStorage.getItem('petSaudeRelatorio:v2')
        || localStorage.getItem('petSaudeRelatorio:v1');
      if(!raw){ linhas = []; return; }
      try{
        const parsed = JSON.parse(raw);
        setHeader(parsed.header);
        linhas = (parsed.linhas || []).map(l=>({
          data:l.data||'',
          desc:l.desc||'',
          entrada:l.entrada||'',
          saida:l.saida||'',
          carga:l.carga||'00:00'
        }));
      }catch(e){ linhas=[]; }
    }

    // ===== Ações =====
    document.getElementById('addLinha').addEventListener('click', ()=>{
      linhas.push({data:'', desc:'', entrada:'', saida:'', carga:'00:00'});
      render(); save();
    });
    document.getElementById('dupLinha').addEventListener('click', ()=>{
      if(linhas.length===0) return;
      const last = linhas[linhas.length-1];
      linhas.push({...last}); render(); save();
    });
    document.getElementById('remSel').addEventListener('click', ()=>{
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const keep = [];
      rows.forEach((tr, idx)=>{
        const checked = tr.querySelector('input[type="checkbox"]').checked;
        if(!checked) keep.push(linhas[idx]);
      });
      linhas = keep; render(); save();
    });
    document.getElementById('limparTudo').addEventListener('click', ()=>{
      if(!confirm('Limpar todos os dados?')) return;
      ['colaborador','vinculo','periodo','cenario'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      ['eixo','atividadeGT'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      linhas = [];
      render(); save();
    });

    // salvar cabeçalho ao alterar
    [...HDR_KEYS, ...SELECT_KEYS].forEach(id=>{
      const el = document.getElementById(id);
      el?.addEventListener('input', save);
      el?.addEventListener('change', save);
    });

    // Exportar / Importar
    document.getElementById('exportJson').addEventListener('click', ()=>{
      const payload = {exportedAt:new Date().toISOString(), header:getHeader(), linhas};
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'pet_saude_relatorio.json'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('importJson').addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = () => {
        const file = inp.files?.[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            setHeader(data.header || null);
            linhas = (data.linhas || []);
            render(); save();
          }catch(e){ alert('Arquivo inválido.'); }
        };
        reader.readAsText(file);
      };
      inp.click();
    });

    // ===== Impressão / PDF =====
    function validarCabecalho(){
      const req = ['colaborador','vinculo','periodo','cenario'];
      let ok = true;
      for(const id of req){
        const el = document.getElementById(id);
        if(!el.value){ ok=false; el.style.borderColor='red'; } else el.style.borderColor='';
      }
      if(!document.getElementById('eixo').value) ok=false;
      if(!document.getElementById('atividadeGT').value) ok=false;
      if(!ok) alert("Preencha todos os campos obrigatórios do cabeçalho!");
      return ok;
    }

    document.getElementById('btnImprimir').addEventListener('click', ()=>{
      if(validarCabecalho()) window.print();
    });

    document.getElementById('btnBaixarPDF').addEventListener('click', ()=>{
      if(!validarCabecalho()) return;
      // Força modo paisagem apenas durante esta impressão
      document.documentElement.classList.add('for-pdf-landscape');
      window.print();
      // Remove a classe após a tentativa de impressão
      setTimeout(()=>document.documentElement.classList.remove('for-pdf-landscape'), 1000);
    });

    // Inicialização
    load(); render();
    if(linhas.length===0){
      linhas = [{},{},{}].map(()=>({data:'', desc:'', entrada:'', saida:'', carga:'00:00'}));
      render(); save();
    }
  </script>
</body>
</html>
